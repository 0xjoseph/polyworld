conf=../../Makefile.conf
include ${conf}

target=${APP_TARGET}
blddir=${APP_BLDDIR}

# The generated Qt project and make files
qt_project=./.qt.pro
qt_makefile=./.qt.mak

qt_modules=gui opengl core
cxxflags=${CXXFLAGS} ${LIBRARY_CXXFLAGS} ${OMP_CXXFLAGS} ${OPENGL_CXXFLAGS}
libs=${LIBRARY_LIBS} ${OMP_LIBS} ${OPENGL_LIBS}

.PHONY: ${qt_project} qt_build clean

# Run the makefile generated by qmake.
qt_build: ${qt_makefile}
	+ make -f ${qt_makefile}
	@rm ${qt_makefile}
	@rm ${qt_project}

# Generate a makefile from the Qt project file
${qt_makefile}: ${qt_project}
	@qmake -o ${qt_makefile} ${qt_project}

# Generate the Qt project file
${qt_project}:
	@rm -f $@
	@echo "CONFIG += qt" >> $@
	@echo "QT = ${qt_modules}" >> $@
	@echo "QMAKE_CXX=${CXX}" >> $@
	@echo "QMAKE_CXXFLAGS += ${cxxflags}" >> $@
	@echo "LIBS += ${libs}" >> $@
	@echo "TARGET = $(shell basename ${target})" >> $@
	@echo "DESTDIR = $(shell dirname ${target})" >> $@
	@echo "OBJECTS_DIR = ${blddir}" >> $@
	@echo "MOC_DIR = ${blddir}" >> $@
	@find -name "*.cc" | awk '{printf "SOURCES += " $$1 "\n"}' >> $@
	@find -name "*.h" | awk '{printf "HEADERS += " $$1 "\n"}' >> $@

clean:
	rm -rf ${blddir}
	rm -f ${qt_makefile}
	rm -f ${qt_project}